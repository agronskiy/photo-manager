\section{Администрирование системы} \label{admin_section}

\subsection{Особенности установки и настройки базы данных}

\PM\ гарантированно работает с БД PostgreSQL 8.3 (и более высоких версий). При
установке на сервер и настройке следует уделить особое ввнимание следующим
особенностям:

\begin{enumerate}
  \item Устанавливать БД следует с \textbf{русской локалью} (либо с локалью
  того языка, на котором будут аннотироваться фотографии). Поменять локаль
  после установки уже не выйдет. Наличие правильной локали обеспечивает
  адеватный полнотекстовый поиск с учетом особенностей грамматики
  соответствующего языка
  \item При установке БД следует удостовериться, что в среди расширений установлено
  расширение
  \textbf{TSearch} (обеспечивает быстрый полнотекстовый поиск, в версии PostgreSQL 8.3
  устанавливается <<по умолчанию>>).
  \item При установке БД необходимо удостовериться, что в качестве расширения
  установлено расширение \textbf{tablefunc} (мера скорее предупредительная,
  т.к. данное расширение устанавливается вместе с таблицами базы данных \PM)
\end{enumerate}

Для обеспечения работы \PM\ на сервере БД необходимо проделать следующие шаги:
\begin{enumerate}
  \item Создать базу данных \verb"pm_database" выполнив SQL-запрос из файла
  \verb"pm_database_create.sql"
  \item Организовать структуру созданной базы данных, для чего, находясь в базе
  данных \verb"pm_database", выполнить SQL-запрос из файла
  \verb"pm_database_organize.sql".
  \item (v 1.2.1) Загрузить начальные данные, необходимые для работы программы,
  выполнив (с соответствующей заменой)
  SQL-запрос:
    \verb"COPY pm_aux FROM 'Путь к файлу pm_database_aux.txt'"
\end{enumerate}

\subsection{Описание базы данных \texttt{pm\_database} }

Рабочая база данных программы \PM\ состоит из таблиц:
\begin{itemize}
  \item \verb"pm_inv"~--- таблица, содержащая информацию о <<папках>>
  \item \verb"pm_images"~--- таблица, содержащая метаданные и изображения малого
  предпросмотра
  \item \verb"pm_bigimages"~--- таблица, содержащая изображения крупного предпросмотра
  \item \verb"pm_categories"~--- таблица, содержащая дерево категорий программы
  \item \verb"pm_aux"~--- вспомогательная таблица, содержащая глобальные настройки и
  другую служебную информацию
\end{itemize}

\subsection{Рекомендации по распределению пользовательских прав БД}

Администратору БД рекомендуется создать трёх пользователей в рамках БД и
наделить следующими привилегиями

\begin{enumerate}
  \item Суперадминистратор: \verb"SELECT", \verb"INSERT",
  \verb"UPDATE", \verb"DELETE" --- все таблицы.
  \item Редактор: \verb"SELECT" --- все таблицы,
  \verb"INSERT", \verb"UPDATE", \verb"DELETE" --- все таблицы, кроме \verb"pm_aux".
  \item Пользователь: \verb"SELECT" --- все таблицы, \verb"INSERT",
  \verb"UPDATE", \verb"DELETE" --- нет.
\end{enumerate}

\begin{prim}
  При этом подразумевается, что всем трем пользователям, должно быть дано право
  \verb"CONNECT" на базу данных \verb"pm_database", а также право \verb"USAGE" на
  схему \verb"public" в этой базе.
\end{prim}

При такой политике следует давать данные для подключения БД для редакторов~---
пользователь <<редактор>>, для пользователей~--- <<пользователь>>.
Администраторские права требуются администратору для доступа к таблице \verb"pm_aux", в
которой хранятся настройки системы \PM.

\subsection{Изменение настроек функционирования системы \PM}

Настройки хранятся в таблице \verb"pm_aux":
\begin{itemize}
  \item \verb"editor_saving": значение этого поля определяет политику
  разрешения сохранений изображений на локальные машины редакторскими версиями
  программы. Возможные значения:

    \begin{tabular}{|c|p{8.5cm}|}
      \hline
      % after \\: \hline or \cline{col1-col2} \cline{col3-col4} ...
      \verb"1" \verb"xxx yyy" & разрешено сохранение размером не более \verb"xxx"$\times$\verb"yyy" (\verb"xxx"~--- ширина)
      \\ \hline
      \verb"0" & разрешено сохранение в оригинальном размере \\ \hline
      \verb"-1" & сохранение запрещено \\
      \hline
    \end{tabular}
  \item \verb"client_saving"~--- аналогично, политика сохранения
  пользовательскими версиями программы.
  \item (начиная с версии 1.2.1) \verb"upload_size"~--- политика загрузки
  изображений в систему \PM. Значение \verb"0"~--- загрузка в оригинальном размере.
  Значение \verb"1 xxx yyy"~--- ограничения на размер загружаемых изображений (все изображения,
  загружаемые в систему, автоматически сжимаются). Формат аналогичен формату \verb"editor_saving"
\end{itemize}

\subsection{Резервные копии БД}

Делать резервные  копии средствами PostgreSQL не рекомендуется, лучше
воспользоваться программами т.н. \textbf{инкрементального} бэкапа, и делать
резервную копию директории \verb"data" (название может отличатся)~---
директории с данными PostgreSQL.
